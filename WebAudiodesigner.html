<!doctype html>
<html>
<head>
<meta charset="utf-8">
</head>
<body>
<script src='wadengine.js'></script>
<script>
var waddata = [{n:"destination",x:1055,y:485},{n:"bufsrc1",x:28,y:69,p:{"loop":true,"buffer":"loop.wav"},c:["filt1","filt2","filt3","filt4","filt9","filt10"]},{n:"filt1",x:237,y:74,p:{"type":"bandpass","frequency":220,Q:8},c:["shaper1"]},{n:"filt2",x:236,y:153,p:{"type":"bandpass","frequency":440,Q:8},c:["shaper2"]},{n:"filt3",x:237,y:233,p:{"type":"bandpass","frequency":660,Q:8},c:["shaper3"]},{n:"filt4",x:237,y:313,p:{"type":"bandpass","frequency":880,Q:8},c:["shaper4"]},{n:"shaper1",x:400,y:74,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt5"]},{n:"shaper2",x:399,y:155,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt6"]},{n:"shaper3",x:401,y:233,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt7"]},{n:"shaper4",x:400,y:312,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt8"]},{n:"filt5",x:581,y:74,p:{"frequency":50},c:["gain1.gain"]},{n:"filt6",x:581,y:155,p:{"frequency":50},c:["gain2.gain"]},{n:"filt7",x:581,y:237,p:{"frequency":50},c:["gain3.gain"]},{n:"filt8",x:580,y:317,p:{"frequency":50},c:["gain4.gain"]},{n:"gain1",x:877,y:335,p:{"gain":0},c:["gain7"]},{n:"gain2",x:877,y:381,p:{"gain":0},c:["gain7"]},{n:"gain3",x:882,y:421,p:{"gain":0},c:["gain7"]},{n:"gain4",x:878,y:463,p:{"gain":0},c:["gain7"]},{n:"osc1",x:735,y:25,p:{"frequency":220},c:["gain1"]},{n:"osc2",x:737,y:132,c:["gain2"]},{n:"osc3",x:904,y:27,p:{"frequency":660},c:["gain3"]},{n:"osc4",x:905,y:135,p:{"frequency":880},c:["gain4"]},{n:"filt9",x:240,y:390,p:{"type":"bandpass","frequency":1100,Q:8},c:["shaper5"]},{n:"filt10",x:238,y:468,p:{"type":"bandpass","frequency":1320,Q:8},c:["shaper6"]},{n:"shaper5",x:397,y:395,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt12"]},{n:"shaper6",x:394,y:472,p:{"curve":"new Float32Array([\n1,0,1\n])"},c:["filt13"]},{n:"filt12",x:580,y:400,p:{"frequency":50},c:["gain5.gain"]},{n:"filt13",x:583,y:481,p:{"frequency":50},c:["gain6.gain"]},{n:"gain5",x:879,y:502,p:{"gain":0},c:["gain7"]},{n:"gain6",x:880,y:554,p:{"gain":0},c:["gain7"]},{n:"osc5",x:1062,y:24,p:{"frequency":1100},c:["gain5"]},{n:"osc6",x:1065,y:137,p:{"frequency":1320},c:["gain6"]},{n:"gain7",x:1059,y:394,p:{"gain":4},c:["destination"]}]

// (BufferSource) or (Convolver) is used. You should place 
// audio files to samples folder. * Note that the IR files are not MIT licensed.
// sampleurl object has the 'filename':'path to file' pairs.

var sampleurl={
  'loop.wav':'samples/loop.wav',
};

function LoadBuffers(actx,list){
  buf={'_count':Object.keys(list).length,'_ready':false};
  for(name in list){
    var o=buf[name]={};
    o.req=new XMLHttpRequest();
    o.req.open('GET',list[name],true);
    o.req.responseType='arraybuffer';
    o.req.buf=buf;
    o.req.nam=name;
    o.req.onload=function(){
      if(this.response){
        actx.decodeAudioData(this.response,
          function(b){
            this.buf[this.nam].data=b;
            if(--this.buf._count==0)
              this.buf._ready=true;
          }.bind(this),
          function(){}
        );
      }
    };
    o.req.onerror=function(){};
    try{o.req.send();} catch(e){}
  }
  return buf;
}

function AudioEngine(audioctx,destination){
  this.audioctx = audioctx;
  if(!audioctx){
     AudioContext = window.AudioContext||window.webkitAudioContext;
     this.audioctx = new AudioContext();
  }
  if(!destination)
    this.destination=this.audioctx.destination;
  this.buffers = LoadBuffers(this.audioctx,sampleurl);
  this.filt1 = this.audioctx.createBiquadFilter();
  this.filt1.type = "bandpass";
  this.filt1.frequency.value = 220;
  this.filt1.Q.value = 8;
  this.filt2 = this.audioctx.createBiquadFilter();
  this.filt2.type = "bandpass";
  this.filt2.frequency.value = 440;
  this.filt2.Q.value = 8;
  this.filt3 = this.audioctx.createBiquadFilter();
  this.filt3.type = "bandpass";
  this.filt3.frequency.value = 660;
  this.filt3.Q.value = 8;
  this.filt4 = this.audioctx.createBiquadFilter();
  this.filt4.type = "bandpass";
  this.filt4.frequency.value = 880;
  this.filt4.Q.value = 8;
  this.shaper1 = this.audioctx.createWaveShaper();
  this.shaper1.curve = new Float32Array([
1,0,1
]);
  this.shaper2 = this.audioctx.createWaveShaper();
  this.shaper2.curve = new Float32Array([
1,0,1
]);
  this.shaper3 = this.audioctx.createWaveShaper();
  this.shaper3.curve = new Float32Array([
1,0,1
]);
  this.shaper4 = this.audioctx.createWaveShaper();
  this.shaper4.curve = new Float32Array([
1,0,1
]);
  this.filt5 = this.audioctx.createBiquadFilter();
  this.filt5.frequency.value = 50;
  this.filt6 = this.audioctx.createBiquadFilter();
  this.filt6.frequency.value = 50;
  this.filt7 = this.audioctx.createBiquadFilter();
  this.filt7.frequency.value = 50;
  this.filt8 = this.audioctx.createBiquadFilter();
  this.filt8.frequency.value = 50;
  this.gain1 = this.audioctx.createGain();
  this.gain1.gain.value = 0;
  this.gain2 = this.audioctx.createGain();
  this.gain2.gain.value = 0;
  this.gain3 = this.audioctx.createGain();
  this.gain3.gain.value = 0;
  this.gain4 = this.audioctx.createGain();
  this.gain4.gain.value = 0;
  this.filt9 = this.audioctx.createBiquadFilter();
  this.filt9.type = "bandpass";
  this.filt9.frequency.value = 1100;
  this.filt9.Q.value = 8;
  this.filt10 = this.audioctx.createBiquadFilter();
  this.filt10.type = "bandpass";
  this.filt10.frequency.value = 1320;
  this.filt10.Q.value = 8;
  this.shaper5 = this.audioctx.createWaveShaper();
  this.shaper5.curve = new Float32Array([
1,0,1
]);
  this.shaper6 = this.audioctx.createWaveShaper();
  this.shaper6.curve = new Float32Array([
1,0,1
]);
  this.filt12 = this.audioctx.createBiquadFilter();
  this.filt12.frequency.value = 50;
  this.filt13 = this.audioctx.createBiquadFilter();
  this.filt13.frequency.value = 50;
  this.gain5 = this.audioctx.createGain();
  this.gain5.gain.value = 0;
  this.gain6 = this.audioctx.createGain();
  this.gain6.gain.value = 0;
  this.gain7 = this.audioctx.createGain();
  this.gain7.gain.value = 4;
  this.filt1.connect(this.shaper1);
  this.filt2.connect(this.shaper2);
  this.filt3.connect(this.shaper3);
  this.filt4.connect(this.shaper4);
  this.shaper1.connect(this.filt5);
  this.shaper2.connect(this.filt6);
  this.shaper3.connect(this.filt7);
  this.shaper4.connect(this.filt8);
  this.filt5.connect(this.gain1.gain);
  this.filt6.connect(this.gain2.gain);
  this.filt7.connect(this.gain3.gain);
  this.filt8.connect(this.gain4.gain);
  this.gain1.connect(this.gain7);
  this.gain2.connect(this.gain7);
  this.gain3.connect(this.gain7);
  this.gain4.connect(this.gain7);
  this.filt9.connect(this.shaper5);
  this.filt10.connect(this.shaper6);
  this.shaper5.connect(this.filt12);
  this.shaper6.connect(this.filt13);
  this.filt12.connect(this.gain5.gain);
  this.filt13.connect(this.gain6.gain);
  this.gain5.connect(this.gain7);
  this.gain6.connect(this.gain7);
  this.gain7.connect(this.destination);
  this.start=function(){
    this.bufsrc1 = this.audioctx.createBufferSource();
    this.bufsrc1.buffer = this.buffers['loop.wav'].data;
    this.osc1 = this.audioctx.createOscillator();
    this.osc1.frequency.value = 220;
    this.osc2 = this.audioctx.createOscillator();
    this.osc3 = this.audioctx.createOscillator();
    this.osc3.frequency.value = 660;
    this.osc4 = this.audioctx.createOscillator();
    this.osc4.frequency.value = 880;
    this.osc5 = this.audioctx.createOscillator();
    this.osc5.frequency.value = 1100;
    this.osc6 = this.audioctx.createOscillator();
    this.osc6.frequency.value = 1320;
    this.bufsrc1.connect(this.filt1);
    this.bufsrc1.connect(this.filt2);
    this.bufsrc1.connect(this.filt3);
    this.bufsrc1.connect(this.filt4);
    this.bufsrc1.connect(this.filt9);
    this.bufsrc1.connect(this.filt10);
    this.osc1.connect(this.gain1);
    this.osc2.connect(this.gain2);
    this.osc3.connect(this.gain3);
    this.osc4.connect(this.gain4);
    this.osc5.connect(this.gain5);
    this.osc6.connect(this.gain6);
    this.bufsrc1.start(0);
    this.osc1.start(0);
    this.osc2.start(0);
    this.osc3.start(0);
    this.osc4.start(0);
    this.osc5.start(0);
    this.osc6.start(0);
  };
}
window.addEventListener('load',function(){audioengine=new AudioEngine()});
</script>
<button onclick='audioengine.start()'>Play</button><br/>
</body>
</html>
